<!--
Element providing an overview for current libraries working computers

##### Example

    <uqlibrary-computers></uqlibrary-computers>

    <script>
    (function () {

      window.addEventListener('polymer-ready', function() {

        var computers = document.querySelector('uqlibrary-computers');

        computers.computers = [

          ];
      });
    }());
  </script>

@element uqlibrary-computers
@blurb Element providing an overview for current libraries working computers
@status alpha
@homepage http://uqlibrary.github.io/uqlibrary-computers
-->

<link rel="import" href="../uqlibrary-elements/0.5.4/lib/vulcanized.html">



<polymer-element name="uqlibrary-computers" layout center attributes="computers autoload">
  <template>
    <link rel="stylesheet" href="../uqlibrary-elements/resources/theme/element.css">
    <uqlibrary-api-account id="account"></uqlibrary-api-account>
    <uqlibrary-api-computer-availability id="computersApi"></uqlibrary-api-computer-availability>

    <uqlibrary-ga id="ga" appName="Computers"></uqlibrary-ga>
    <core-localstorage name="uqlibrary-computers-storage" id="localStorage" value="{{branch}}"></core-localstorage>
    <core-drawer-panel id="drawerPanel" drawerWidth="256px" responsiveWidth="768px">
      <core-header-panel drawer id="drawer">
        <uqlibrary-menu account="{{user}}"></uqlibrary-menu>
      </core-header-panel>

      <core-header-panel main id="main">
        <core-toolbar>
          <paper-icon-button id="toolBarLeftButton" icon="menu" core-drawer-toggle></paper-icon-button>
          <span flex id="toolbar-page-title">Library computers</span>

        </core-toolbar>

        <div id="content">
          <div>
            <paper-shadow id="branchWrapper" class="card" z="1" horizontal layout>
              <div id="branchSelect" relative on-tap="{{onTapSelectBranch}}">
                <div horizontal layout center>
                  <div flex>{{selected.library}}</div>
                  <div><core-icon icon="{{$.branches.opened ? 'arrow-drop-up' : 'arrow-drop-down'}}"></core-icon></div>
                </div>
              </div>
              <div>
                <paper-dropdown
                  id="branches"
                  class="no-padding"
                  relatedTarget="{{$.branchSelect}}"
                  autoFocusDisabled="true">
                  <core-selector
                    id="branchSelector"
                    selected="{{branch}}"
                    selectedAttribute="">

                    <template repeat="{{computer, idx in computers}}">
                      <paper-item class="{{(idx+1) === computers.length ? 'last' : ''}}">
                        <div layout horizontal flex>
                          <div flex class="truncate">{{computer.library}}</div>
                          <div class="caption" end-justified><span class="{{computer.totalAvailable > 0 ? 'available' : 'unavailable'}}">{{computer.totalAvailable}}</span>/{{computer.total}}</div>
                        </div>

                      </paper-item>
                    </template>
                  </core-selector>
                </paper-dropdown>
              </div>
            </paper-shadow>
          </div>
          <div id="availability">
            <template repeat="{{selected.availability}}">
              <div class="availability-item">
                <div class="totals">{{Available}} available of {{total}} PCs</div>
                <div class="title">{{title}}</div>
                <div class="free">
                  <paper-progress value="{{percent}}">{{title}}</paper-progress>
                </div>
              </div>
            </template>
          </div>
        </div>
      </core-header-panel>

    </core-drawer-panel>

  </template>

  <script>
    Polymer('uqlibrary-computers', {

      /**
       * The `computers` attribute contains information about computers
       *
       * @property computers
       * @type Object
       */

      publish: {
        computers: null,
        autoload: true
      },
      user: {},
      branch: null,
      selected: 0,

      ready: function() {
        var that = this;

        this.$.account.addEventListener('uqlibrary-api-account-loaded', function(e) {
          if (e.detail.hasSession) {
            if(e.detail.classes) {
              that.user = e.detail;
            }
          }
        });

        this.$.computersApi.addEventListener('uqlibrary-api-computer-availability-loaded', function(e) {
          that.computers = e.detail;
          if(that.branch == null) {
            that.branch = 0;
          }
        });
        if(this.autoload){
          this.$.account.get();
          this.$.computersApi.get();
        }
      },

      computersChanged: function() {
        if(this.computers.length > 0 ) {
          this.computers.forEach(function (v) {
            v.library = v.library.replace('&amp;', '&');
            v.totalAvailable = 0;
            v.total = 0;
            var s = [];
            for (var k in v.availability) {
              var a = v.availability[k];
              a.title = k;
              a.total = (a.Available + a.Occupied);
              a.percent = Math.floor((a.Available / a.total * 100));

              v.totalAvailable += a.Available;
              v.total += a.total;

              s.push(a);
            }
            v.availability = s;
          });
          this.selected = this.computers[this.branch];
        }
        this.fire('uqlibrary-computers-loaded');
      },

      onTapSelectBranch: function () {
        this.$.branches.opened = true;
      },

      branchChanged: function (oldValue, newValue) {
        if(oldValue != null) {
          this.$.branches.opened = false;
          this.selected = this.computers[this.branch];
          this.$.ga.addEvent('Library Selected', this.selected.library);
        }

      }

    });
  </script>

</polymer-element>